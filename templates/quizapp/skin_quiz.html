{% extends 'base.html' %}{% load crispy_forms_tags %}{% load static %}
{% block content %}

    <style>
        body {
            background-color: #0c499c;
        }
    </style>

    <div class="mt-5">
        <div class="quiz">
            <div class="quiz_header">
                <div class="quiz_user">
                    <h4>Welcome!
                        <span class="name"></span>
                        <span id="ques_count" style="margin-left: 80px"></span>
                    </h4>
                </div>
                <div class="quiz_timer">
                    <span class="time">00:00</span>
                </div>
            </div>
            <div class="quiz_body">
                <div id="questions">
                    <h2 id="question"></h2>
                    <ul id="choice" class="option_group"></ul>
                    <form name="watr-intake">
                        <table class="option_table" id="option_table"></table>
                        <h3 class="float-right pt-3" id="water-content"></h3>
                    </form> 
                </div>
                <p id="note" class="mt-5 mb-4"></p>
                <a id="btn-previous" class="btn-next invisible" href="#" onclick="previous()">Previous</a>
                <a id="btn-next" class="btn-next float-right invisible" href="#" onclick="next()">Next Question</a>
            </div>
            
        </div>
    </div>


    <script type="text/javascript" src="{% static 'assets/dist/js/jquery.js' %}"></script>
    <script type="application/javascript">
        let next_quiz = '{{ next_quiz }}'
        
        let user_name = sessionStorage.getItem("user_name");
        document.querySelector("span.name").innerHTML = user_name;

        let questions = [
            {% for x in questions %}
                {
                    id: '{{ x.id }}',
                    question: '{{ x.name }}',
                    question_code: '{{ x.code }}',
                    choice_data: [
                        {% for c in x.choice_set.all %}
                            {
                                choice_id: '{{ c.id }}',
                                choice_text: '{{ c.name }}'
                            },
                        {% endfor %}
                    ]
                },
            {% endfor %}
        ];
        let question_count = 0;
        let points = 0;
        let preBtn = document.getElementById('btn-previous');
        let nextBtn = document.getElementById('btn-next');
        let question_elm = document.getElementById("question");
        let choice_elm = document.getElementById("choice");
        let option_table = document.getElementById("option_table");
        let ques_count = document.getElementById("ques_count");
        let water_content = document.getElementById('water-content');
        let note = document.getElementById('note');
        let e1_value;
        let e2_value;
        let e3_value;
        let e4_value;
        ans_data = [];

        window.onload = function () {
            show(question_count);
        };


        function previous() {
            question_count--;
            show(question_count);
            let option = document.querySelectorAll("li.option");
            let ans_option = `ans-${ans_data[question_count]}`;
            let ans_option_elm = document.getElementById(ans_option);

            if (ans_option_elm) {
                ans_option_elm.classList.add("active");
            }

        }

        function next() {
            let el1 = document.getElementById('ans-125');
            let el2 = document.getElementById('ans-126');
            let el3 = document.getElementById('ans-127');
            let el4 = document.getElementById('water-content');
            
            if(el1){
                e1_value = el1.value,
                e2_value = el2.value,
                e3_value = el3.value,
                e4_value = el4.textContent
            };

            let retrieve_ans = document.querySelector("li.option.active");
            if(retrieve_ans){
                ans_data[question_count] = retrieve_ans.dataset.choice_id;
                //retrieve_ans.getAttribute('data-choice_id')
                //ans_data.push(answer_data);
            }else{
                ans_data[question_count] = 0;
            }
            // if the question is last then redirect to final page
            if (question_count === questions.length - 1) {
                nextBtn.classList.add('invisible');
                sessionStorage.setItem("time", time);
                clearInterval(mytime);
                SaveAns(ans_data);
            } else {
                question_count++;
                show(question_count);
            }
        }

        function show(count) {
            water_content.classList.add('invisible');
            note.classList.add('invisible');
            if (question_count <= 0) {
                preBtn.classList.add('invisible');
            } else {
                preBtn.classList.remove('invisible');
            }
            nextBtn.classList.add('invisible');
            $(choice_elm).empty();
            $(question_elm).empty();
            $(option_table).empty();
            ques_count.innerHTML = `Question ${count + 1} of ${questions.length}`;
            let question_res = `<h2>Q${count + 1}. ${questions[count].question}</h2>`;
            $(question_elm).append(question_res);
            let choice_data = questions[count].choice_data;
            let choice_res;
            for (let i = 0; i < choice_data.length; i++) {
                if (questions[count].question_code == 107) {
                    choice_res = `
                                   <tr>
                                       <td class="pt-0 pb-0">${choice_data[i].choice_text}</td>
                                       <td width="20%" class="p-0"><input type="text" class="form-control formtest" id='ans-${choice_data[i].choice_id}' data-choice_id='${choice_data[i].choice_id}'></td>
                                   </tr>
                                `;
                    $(option_table).append(choice_res);
                } else {
                    choice_res = `<li class="option" id='ans-${choice_data[i].choice_id}' data-choice_id='${choice_data[i].choice_id}'>${choice_data[i].choice_text}</li>`;
                    $(choice_elm).append(choice_res);
                }
            }
            if(questions[count].question_code == 107){
                watercontent();
            }else{
                toggleActive();
            }
        }

        function watercontent(){
            note.innerHTML = "Note: As per international standards 1ltr = 4.16 glasses"
            let elm1 = document.getElementById('ans-125');
            let elm2 = document.getElementById('ans-126');
            let elm3 = document.getElementById('ans-127');
            let elm4 = document.getElementById('ans-128');
            let elm5 = document.getElementById('ans-129');
            let elm6 = document.getElementById('ans-130');
            elm4.readOnly = true;
            elm5.readOnly = true;
            elm6.readOnly = true;
            let water_info;
            
            $("input").focusout(function () {
                let elm = $(this);
                elm4_value = ((elm1.value * 2.2 * 2 / 3 * 30 / 240) + (12 * 30 * elm2.value / 30 / 240));
                elm5_value = (elm4_value - elm3.value);
                elm6_value = (elm5_value / elm4_value * 100);
                elm4.value = parseFloat(elm4_value).toFixed(1);
                elm5.value = parseFloat(elm5_value).toFixed(1);
                elm6.value = parseFloat(elm6_value).toFixed(1);
                
                if (elm1.value >= 0 && elm2.value >= 0 && elm3.value) { //if (elm.attr('id') === 'ans-127')
                    water_content.classList.remove('invisible');
                    note.classList.remove('invisible');
                    nextBtn.classList.remove('invisible')
                    let msg = parseFloat(elm6_value);
                    if(msg <= 0){
                        //console.log('Hydrated ( % deficit : 0 or negative)');
                        water_info = 'Hydrated'
                    } else if(msg > 25){
                        //console.log('Dehydrated (% deficit is greater than 25%)');
                        water_info = 'Dehydrated'
                    } else {
                        //console.log('Slightly Dehydrated (  % deficit is less than >0 - 25%)');
                        water_info = 'Slightly Dehydrated' 
                    };
                } else {
                    water_info = '' 
                    nextBtn.classList.add('invisible')
                }
                water_content.innerHTML = water_info;
            });
        }

        function toggleActive() {
            let option = document.querySelectorAll("li.option");
            for (let i = 0; i < option.length; i++) {
                option[i].onclick = function () {
                    for (let i = 0; i < option.length; i++) {
                        if (option[i].classList.contains("active")) {
                            option[i].classList.remove("active");
                        }
                    }
                    option[i].classList.add("active");
                    nextBtn.classList.remove('invisible')
                };
            }
        }


        ///////////////time///////
        let dt = new Date(new Date().setTime(0));
        let ctime = dt.getTime();
        let seconds = Math.floor((ctime % (1000 * 60)) / 1000);
        let minutes = Math.floor((ctime % (1000 * 60 * 60)) / (1000 * 60));
        //console.log(seconds, minutes);
        let time = 0;
        let mytime = setInterval(function () {
            time++;

            if (seconds < 59) {
                seconds++;
            } else {
                seconds = 0;
                minutes++;
            }
            let formatted_sec = seconds < 10 ? `0${seconds}` : `${seconds}`;
            let formatted_min = minutes < 10 ? `0${minutes}` : `${minutes}`;
            document.querySelector("span.time").innerHTML = `${formatted_min} : ${formatted_sec}`;
        }, 1000);
        ////////////////////////sae data/////////////
        //let SaveAns = (obj) => {
        function SaveAns(obj) {
            let json = JSON.stringify(obj);
            let params = {user_choice: json, user_name: user_name};
            let url = '/quizapp/quiz_answers/';
            $.ajax({
                url: url,
                type: 'get',
                contentType: 'application/json',
                data: params,
                dataType: 'json',
                success: function (response) {
                    if (response) {
                        if(next_quiz ===  'True'){
                            WaterIntake();
                            location.href = '/quizapp/skin_concerns/';
                        } else {
                            location.href = `/quizapp/products/${user_name}/`; 
                        }
                    }
                }
            })
        }

        ////////////////////////save water information/////////////
        function WaterIntake() {
            let params = {
                user_name : user_name,
                weight : e1_value,
                physical_activity : e2_value,
                water_intake : e3_value,
                status : e4_value
            };
            let url = '/quizapp/water_info/';
            $.ajax({
                url: url,
                type: 'POST',
                data: params,
                dataType: 'json',
                success: function (response) {
                }
            })
        }

    </script>
{% endblock %}